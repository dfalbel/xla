all: $(SHLIB) clone_tf copy_rclient bazel_build copy_librclient

clone_tf:
	@echo "Cloning the tensorflow repository"
	git clone --depth 1 https://github.com/tensorflow/tensorflow.git || true

copy_rclient: clone_tf
	@echo "Cloning R client files"
	cp -r "r-client" "tensorflow/tensorflow/compiler/xla/"

bazel_build: copy_rclient
	@echo "Running bazel build"
	cd tensorflow; bazel build //tensorflow/compiler/xla/r-client:librclient.so

copy_librclient: bazel_build
	@echo "Copying librclient.so"
	cp tensorflow/bazel-bin/tensorflow/compiler/xla/r-client/librclient.so .

$(SHLIB) : copy_librclient

PKG_CPPFLAGS=""
PKG_LIBS=-Wl,-rpath,"." -Wl,-rpath,"/Users/dfalbel/Documents/xla/src" -Wl,-rpath,"/Users/dfalbel/Documents/xla/src/tensorflow/bazel-bin/tensorflow" -L"." -lrclient
